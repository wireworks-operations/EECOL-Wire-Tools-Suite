<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" id="csp-meta" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; font-src https://fonts.googleapis.com; img-src 'self' data:; connect-src 'self' ws://localhost:8765/gun wss://localhost:8765/gun wss://gun-sync.acidgreenservers.com/gun;">
    <script>
        // Dynamic CSP generation for configurable relay servers
        function updateCSPWithRelayServers() {
            try {
                const relayConfig = localStorage.getItem('p2pRelayServers');
                if (!relayConfig) return; // Use default CSP

                const relayServers = JSON.parse(relayConfig);
                if (!Array.isArray(relayServers) || relayServers.length === 0) return;

                // Extract hostnames from relay URLs
                const relayHosts = [];
                relayServers.forEach(url => {
                    try {
                        const urlObj = new URL(url);
                        const wsUrl = urlObj.protocol === 'http:' ? `ws://${urlObj.host}` : `wss://${urlObj.host}`;
                        const wssUrl = `wss://${urlObj.host}`;
                        if (!relayHosts.includes(wsUrl)) relayHosts.push(wsUrl);
                        if (!relayHosts.includes(wssUrl)) relayHosts.push(wssUrl);
                    } catch (e) {
                        console.warn('Invalid relay URL format:', url);
                    }
                });

                if (relayHosts.length === 0) return;

                // Update CSP to include relay servers
                const cspMeta = document.getElementById('csp-meta');
                if (cspMeta) {
                    let cspContent = cspMeta.content;
                    // Replace connect-src directive to include relay hosts
                    const connectSrcMatch = cspContent.match(/connect-src\s+([^;]+);/);
                    if (connectSrcMatch) {
                        const existingConnectSrc = connectSrcMatch[1].trim();
                        const newConnectSrc = existingConnectSrc + ' ' + relayHosts.join(' ');
                        cspContent = cspContent.replace(/connect-src\s+[^;]+;/, `connect-src ${newConnectSrc};`);
                        cspMeta.content = cspContent;
                        console.log('CSP updated with relay servers:', relayHosts);
                    }
                }
            } catch (error) {
                console.warn('Failed to update CSP with relay servers:', error);
            }
        }

        // Update CSP immediately when script runs
        updateCSPWithRelayServers();
    </script>
    <title>EECOL Cutting Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/cutting-records.css">
    <link rel="stylesheet" href="../../assets/css/eecol-theme.css">
    <link rel="manifest" href="../../assets/manifest.json">
    <meta name="theme-color" content="#0058B3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EECOL Tools">
    <link rel="apple-touch-icon" href="../../assets/icons/icon-192x192.png">
    <script src="../../core/database/indexeddb.js"></script>
    <script src="../../utils/modals.js"></script>
    <script src="../../utils/mobile-menu.js"></script>
    <script src="../../utils/pdf-generator.js"></script>
    <script src="../../core/database/gun-sync.js"></script>
</head>
<body class="p-3 sm:p-6 h-screen flex flex-col eecol-blue-bg">

    <!-- Main Container -->
    <div class="flex-1 w-full max-w-md md:max-w-xl lg:max-w-7xl xl:max-w-9xl bg-[#F0F8FF] p-4 sm:p-6 rounded-xl shadow-2xl mx-auto border-2 border-solid border-[#0058B3] overflow-hidden flex flex-col mb-16 relative">

        <!-- Header -->
        <div class="flex justify-center mb-1">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-lg" style="transform: rotate(-17deg);">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#0058B3;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#004a99;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="12" cy="12" r="11.35" fill="white" stroke="url(#logoGradient)" stroke-width="2"/>
                <rect x="4" y="4" width="4" height="16" rx="1" fill="url(#logoGradient)"/>
                <path d="M 8,6.5 C 12,5.5 16,7.5 20,6.5" stroke="url(#logoGradient)" stroke-width="3.5" stroke-linecap="round"/>
                <path d="M 8,12 C 12,11 16,13 20,12" stroke="url(#logoGradient)" stroke-width="3.5" stroke-linecap="round"/>
                <path d="M 8,17.5 C 12,16.5 16,18.5 20,17.5" stroke="url(#logoGradient)" stroke-width="3.5" stroke-linecap="round"/>
            </svg>
        </div>

        <h1 class="text-3xl font-black mb-3 text-center header-gradient">
            EECOL Cutting Reports
        </h1>
        <p class="mb-5 text-center text-sm font-medium header-gradient">
           Advanced analytics and reporting dashboard for cutting records with charts and insights.
        </p>

        <!-- Manual Refresh Button -->
        <div class="flex justify-center mb-4">
            <button id="manualRefreshBtn"
                    onclick="manualRefresh()"
                    class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 flex items-center gap-2 text-sm"
                    title="Refresh data from cutting records">
                üîÑ Refresh Data
            </button>
        </div>

        <div class="flex-1 overflow-y-auto">
            <div class="flex flex-col pb-4">
                <div class="space-y-6">

                    <!-- Quick Stats Dashboard -->
                    <div class="space-y-3">
                        <!-- First Row - 4 boxes -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-blue-500">
                                <div class="text-2xl font-bold text-blue-600" id="totalCutsStat">0</div>
                                <div class="text-xs font-semibold text-gray-600">Total Cuts</div>
                                <div class="text-xs text-gray-500 mt-1" id="totalCutsChange">+0 this week</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-green-500">
                                <div class="text-2xl font-bold text-green-600" id="topCutterStat">-</div>
                                <div class="text-xs font-semibold text-gray-600">Top Cutter</div>
                                <div class="text-xs text-gray-500 mt-1" id="topCutterCuts">0 cuts</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-yellow-500">
                                <div class="text-2xl font-bold text-yellow-600" id="topCustomerStat">-</div>
                                <div class="text-xs font-semibold text-gray-600">Top Customer</div>
                                <div class="text-xs text-gray-500 mt-1" id="topCustomerCuts">0 cuts</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-orange-500">
                                <div class="text-2xl font-bold text-orange-600" id="fullPicksStat">0</div>
                                <div class="text-xs font-semibold text-gray-600">Full Picks</div>
                                <div class="text-xs text-gray-500 mt-1" id="fullPicksPercent">0% of total</div>
                            </div>
                        </div>

                        <!-- Second Row - 3 boxes -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-3">
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-cyan-500">
                                <div class="text-2xl font-bold text-cyan-600" id="systemCutsStat">0</div>
                                <div class="text-xs font-semibold text-gray-600">System Cuts</div>
                                <div class="text-xs text-gray-500 mt-1" id="systemCutsPercent">0% of total</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-indigo-500">
                                <div class="text-2xl font-bold text-indigo-600" id="mostCutWireStat">-</div>
                                <div class="text-xs font-semibold text-gray-600">Most Cut Wire Type</div>
                                <div class="text-xs text-gray-500 mt-1" id="mostCutWireCount">0 cuts</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-emerald-500">
                                <div class="text-2xl font-bold text-emerald-600" id="noMarkCutsStat">0</div>
                                <div class="text-xs font-semibold text-gray-600">No Mark Cuts</div>
                                <div class="text-xs text-gray-500 mt-1" id="noMarkCutsPercent">0% of total</div>
                            </div>
                        </div>

                        <!-- Third Row - 2 boxes (Length Metrics at Bottom) -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-2 gap-3">
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-purple-500">
                                <div class="text-2xl font-bold text-purple-600" id="totalLengthStat">0m</div>
                                <div class="text-xs font-semibold text-gray-600">Total Length Cut</div>
                                <div class="text-xs text-gray-500 mt-1" id="avgCutLength">0m avg</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md text-center border-l-4 border-pink-500">
                                <div class="text-2xl font-bold text-pink-600" id="longestCutStat">0m</div>
                                <div class="text-xs font-semibold text-gray-600">Longest Cut Order</div>
                                <div class="text-xs text-gray-500 mt-1" id="longestCutOrder">Order #</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Controls -->
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                            <div class="flex flex-wrap items-center gap-2">
                                <label class="text-sm font-semibold">Chart Type:</label>
                                <select id="chartType" class="p-2 border border-gray-300 rounded text-sm">
                                    <option value="line">üìà Line Chart</option>
                                    <option value="bar">üìä Bar Chart</option>
                                    <option value="pie">ü•ß Pie Chart</option>
                                </select>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <label class="text-sm font-semibold">Period:</label>
                                <select id="reportPeriod" class="p-2 border border-gray-300 rounded text-sm">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <label class="text-sm font-semibold">Date Range:</label>
                                <input type="date" id="startDate" class="p-2 border border-gray-300 rounded text-sm">
                                <span class="text-sm text-gray-500">to</span>
                                <input type="date" id="endDate" class="p-2 border border-gray-300 rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div id="chartError" class="bg-red-100 border-l-4 border-red-500 p-4 rounded-lg shadow-md mb-4 hidden">
                        <h4 class="font-bold text-red-800">‚ö†Ô∏è Offline Mode</h4>
                        <p class="text-sm text-red-700">Charts are disabled due to network connection issues. Charts will be available when internet connection is restored.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                        <!-- Cut Trends Chart -->
                        <div class="bg-white p-4 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3 text-center"><span>üìà</span> <span class="header-gradient">Cut Trends</span></h3>
                            <div class="chart-container">
                                <canvas id="cutTrendsChart"></canvas>
                            </div>
                        </div>

                        <!-- Cutter Performance Chart -->
                        <div class="bg-white p-4 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3 text-center"><span>üë∑</span> <span class="header-gradient">Cutter Performance</span></h3>
                            <div class="chart-container">
                                <canvas id="cutterPerformanceChart"></canvas>
                            </div>
                        </div>

                        <!-- Wire Type Usage Chart -->
                        <div class="bg-white p-4 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3 text-center"><span>üîå</span> <span class="header-gradient">Wire Type Usage</span></h3>
                            <div class="chart-container">
                                <canvas id="wireTypeChart"></canvas>
                            </div>
                        </div>

                        <!-- Customer/Cut Type Distribution Chart -->
                        <div class="bg-white p-4 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3 text-center"><span>üè¢</span> <span class="header-gradient">Customer Distribution</span></h3>
                            <div class="chart-container">
                                <canvas id="customerDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Reports Table -->
                    <div class="bg-white p-4 rounded-xl shadow-lg">
                        <h3 class="text-lg font-bold mb-3 text-center"><span>üìã</span> <span class="header-gradient">Detailed Reports</span></h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left p-2 font-semibold">Metric</th>
                                        <th class="text-center p-2 font-semibold">This Period</th>
                                        <th class="text-center p-2 font-semibold">Last Period</th>
                                        <th class="text-center p-2 font-semibold">Change %</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTable">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="flex justify-center space-x-4 flex-wrap gap-4">
                        <button id="exportReportBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm transition duration-200">
                            üìÑ Export Full Report (CSV)
                        </button>
                        <button id="exportChartsBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition duration-200">
                            üìä Export Charts (PNG)
                        </button>
                        <button id="generatePDFBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm transition duration-200">
                            üìã Generate PDF Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer inside main box -->
        <div class="mt-auto pt-4 border-t border-blue-200 hidden sm:block">
            <div class="flex justify-between items-center mb-2">
                <div class="flex space-x-3">
                    <a href="../cutting-records/cutting-records.html"
                       class="px-3 py-1.5 bg-blue-600 border-2 border-blue-600 text-white font-bold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:bg-blue-700 active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-600 focus:ring-opacity-50 text-xs">
                        ‚úÇÔ∏è Cutting Records
                    </a>
                    <a href="../useful-tool/useful-tool.html" class="px-3 py-1.5 bg-sky-500 border-2 border-sky-500 text-white font-bold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:bg-sky-600 active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-sky-500 focus:ring-opacity-50 text-xs no-underline">Is This Tool Useful?</a>
                    <a href="../live-statistics/live-statistics.html" class="px-3 py-1.5 bg-teal-600 border-2 border-teal-600 text-white font-bold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:bg-teal-700 active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-teal-600 focus:ring-opacity-50 text-xs">
                        üìä Live Statistics
                    </a>
                </div>
                <p class="text-xs text-gray-500 font-mono select-none">v0.8.0.1</p>
            </div>
            <p class="font-medium text-[#0058B3] text-center select-none mb-1">
                Made With ‚ù§Ô∏è By: Lucas and Cline ü§ñ
            </p>
            <p class="text-xs font-semibold header-gradient text-center select-none">
                EECOL Wire Tools 2025 - Enterprise Edition
            </p>
        </div>
    </div>

    <!-- Custom Modal (hidden by default) -->
    <div id="customModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center" id="modalBackdrop">
        <div id="modalContent" class="bg-white rounded-2xl shadow-2xl max-w-md w-full m-4 scale-95 opacity-0 transition-all duration-300 ease-in-out transform border-4 border-[#0058B3]">
            <div class="p-6">
                <div class="flex justify-center mb-4">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="eecol-logo-tilt">
                        <defs>
                            <linearGradient id="modalGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#0058B3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#004a99;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="12" cy="12" r="11.35" fill="white" stroke="url(#modalGradient)" stroke-width="2"/>
                        <rect x="4" y="4" width="4" height="16" rx="1" fill="url(#modalGradient)"/>
                        <path d="M 8,6.5 C 12,5.5 16,7.5 20,6.5" stroke="url(#modalGradient)" stroke-width="3.5" stroke-linecap="round"/>
                        <path d="M 8,12 C 12,11 16,13 20,12" stroke="url(#modalGradient)" stroke-width="3.5" stroke-linecap="round"/>
                        <path d="M 8,17.5 C 12,16.5 16,18.5 20,17.5" stroke="url(#modalGradient)" stroke-width="3.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h2 id="modalTitle" class="text-xl font-bold text-center mb-4 header-gradient">Modal Title</h2>
                <p id="modalMessage" class="text-center text-gray-700 mb-6">Modal message content</p>
                <div id="modalButtons" class="flex justify-center space-x-3">
                    <!-- Buttons will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer place divs here to put them outside the main box window -->

    <script src="../../assets/js/cutting-reports.js"></script>
</body>
</html>
